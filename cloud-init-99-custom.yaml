#cloud-config

preserve_hostname: false

# Auto-upgrade to latest NixOS stable on first boot
bootcmd:
  # Add latest stable NixOS channel (auto-detect or fallback to 25.11)
  - |
    if [ ! -e /root/.nix-channels ]; then
      # Try to detect latest stable from channels page
      LATEST_STABLE=$(curl -s https://channels.nixos.org/ | grep -oP 'nixos-[0-9]+\.[0-9]+"' | grep -v 'small\|unstable' | head -1 | tr -d '"' || echo 'nixos-25.11')
      echo "Adding NixOS channel: $LATEST_STABLE"
      nix-channel --add https://nixos.org/channels/$LATEST_STABLE nixos
      nix-channel --update
    fi

  # Smart swap based on instance RAM
  - |
    if [ ! -f /swapfile ]; then
      RAM_GB=$(free -g | awk "/^Mem:/{print \$2}")
      if [ "$RAM_GB" -le 2 ]; then
        SWAP_SIZE=2
      elif [ "$RAM_GB" -le 8 ]; then
        SWAP_SIZE=$((RAM_GB * 2))
      else
        SWAP_SIZE=16
      fi
      fallocate -l ${SWAP_SIZE}G /swapfile || dd if=/dev/zero of=/swapfile bs=1G count=$SWAP_SIZE
      chmod 600 /swapfile
      mkswap /swapfile
      swapon /swapfile
      grep -q "^/swapfile" /etc/fstab || echo "/swapfile none swap sw 0 0" >> /etc/fstab
      echo "vm.swappiness=10" >> /etc/sysctl.conf
      sysctl -p
    fi
