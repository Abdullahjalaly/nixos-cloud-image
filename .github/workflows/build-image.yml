name: Build NixOS Hetzner Image

on:
  # Manual trigger only - prevents rebuilding on every commit
  # Run via: gh workflow run build-image.yml
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Custom image name (optional)'
        required: false
        default: 'nixos-25.11-netboot'

env:
  IMAGE_NAME: ${{ github.event.inputs.image_name || 'nixos-25.11-netboot' }}

permissions:
  contents: write  # Required for creating releases and pushing commits

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "1.11.2"

      - name: Initialize Packer
        run: packer init nixos-cloud-incremental.pkr.hcl

      - name: Validate Packer config
        run: packer validate nixos-cloud-incremental.pkr.hcl
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

      - name: Build NixOS image (incremental - 3 min)
        run: |
          # Use incremental build (3 min) - NixOS determinism ensures same result
          # Only use nixos-cloud-from-scratch.pkr.hcl (25 min) for first-time base creation
          packer build \
            -var "image_name=${IMAGE_NAME}-$(date +%Y%m%d-%H%M)" \
            nixos-cloud-incremental.pkr.hcl
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

      - name: Verify snapshot created
        run: |
          # Wait a moment for snapshot to be fully available
          sleep 5

          # Verify snapshot was created (for your personal use)
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.HCLOUD_TOKEN }}" \
            "https://api.hetzner.cloud/v1/images?type=snapshot&sort=created:desc")

          SNAPSHOT_ID=$(echo "$RESPONSE" | jq -r '.images[0].id')
          SNAPSHOT_SIZE=$(echo "$RESPONSE" | jq -r '.images[0].image_size')

          echo "âœ… Snapshot created successfully!"
          echo "   Size: ${SNAPSHOT_SIZE} GB"
          echo "   (Snapshot ID kept private for your personal use)"

      - name: Clean up old snapshots (keep last 3)
        if: github.ref == 'refs/heads/main'
        run: |
          # Get all snapshots created by this automation
          SNAPSHOTS=$(curl -s -H "Authorization: Bearer ${{ secrets.HCLOUD_TOKEN }}" \
            "https://api.hetzner.cloud/v1/images?type=snapshot&sort=created:desc" | \
            jq -r '.images[] | select(.labels.created_by == "packer") | .id')

          # Keep the 3 most recent, delete the rest
          echo "$SNAPSHOTS" | tail -n +4 | while read -r id; do
            echo "Deleting old snapshot: $id"
            curl -X DELETE -H "Authorization: Bearer ${{ secrets.HCLOUD_TOKEN }}" \
              "https://api.hetzner.cloud/v1/images/$id"
          done
